##　索引优化

在存储引擎层实现

MySql支持的索引：

B树索引：

- B-tree索引特点：
  - 以B+树的结构存储数据
  - 加快数据的查询速度
  - 更适合进行范围查找
  - 叶子节点指向：
    - innodb:主键
    - myisam：数据物理地址
- 使用场景：
  - 全值匹配
  - 匹配最左前缀的查询
  - 匹配列前缀查询
  - 匹配范围查找
  - 精确匹配左前列并范围匹配另外一列
  - 只访问索引的查询
- 使用限制：
  - 如果不是按照索引最左列开始查找，则无法使用索引
  - 使用索引时不能跳过索引中的列
  - Not in 和 <>操作无法使用索引
  - 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引　



Hash索引：

- 特点：
  - hash索引基于hash表实现，只有查询条件精确匹配hash索引中的所有列时，才能够使用hash索引；即等值查询
  - 引擎会为每一行计算的一个hash码，索引中存储的就是hash码
- 限制：
  - 需要进行二次读取，先找到行，再读取行
  - 按照hash码的顺序存储的，无法用于排序
  - 不支持部分索引查找，也不支持范围查找
  - hash码的计算可能存在hash冲突，例如性别冲突，但身份证号就不冲突



为什么使用索引：

- 减少引擎需要扫描的数据量。innodb一页大小为16K，能存的索引更多，查询更快。
- 根据索引进行排序，以避免使用临时表
- 索引可以把随机IO变为顺序IO

太多索引缺点：

- 索引会增加写操作的成本。innodb把多次写变为一次写，增加写缓存。
- 太多的索引会增加查询优化器的选择时间



索引优化策略：

1. 索引列上不能使用表达式或函数：
   1. select...from product where to_days(index)-to_days(current)<=30
   2. select...from product where index <= data_add(current,30)
2. B树索引大小限制：Innodb(767字节)，myisam(1000字节)。采用前缀索引，但前缀索引可能会降低索引的唯一性(选择性)。
3. 联合索引：
   1. 经常会被使用到的列优先
   2. 选择性高的列优先
   3. 宽度小的列优先
4. 覆盖索引：一个索引包含（或者说覆盖）所有需要查询的字段的值
   1. ​
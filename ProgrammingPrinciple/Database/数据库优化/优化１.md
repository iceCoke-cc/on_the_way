 数据库架构：

1个master + n个slave：

问题：

1. 如果master挂了,需要从slave中选出一个，这个过程太耗时。
2. 1个master,n个slave，有数据传输瓶颈。

监控信息：

QPS: req/sec　请求数每秒

TPS：峰值时间的每秒请求数。原理：每天80%的访问集中在20%的时间里。

PV:页面被浏览的次数

并发量：同一时间处理的请求数

磁盘IO：fash IO



影响数据库的因素：

- sql查询速度
- 网卡流量
- 服务器硬件
- 磁盘IO

大表：千万行、超过10G。

- 分库分表
  - 难点：　分表主键的选择、分表后跨分区数据的查询和统计。
- 大表的历史数据归档
  - 优点：减少对前后端业务的影响。
  - 难点：归档时间点的选择、如何进行归档操作。

大事务：运行时间比较长，操作的数据比较多的事务。

- 问题：
  - 锁定太多数据，造成大量的阻塞和锁超时。
  - 回滚时所需时间比较长。
  - 执行时间长，容易造成主从延迟。
- 解决：
  - 避免一次处理太多的数据
  - 移除不必要在事务中的操作(查询)

事务的隔离级别：查看表的隔离级别:show variables like '%iso%';

begin;开始一个事务，commit;提交一个事务

1. 未提交读 READ UNCOMMITED:一个事务可以读取另一个未提交事务的数据（脏读）
2. 已提交读(不可重复读) READ COMMITED:一个事务要等另一个事务提交后才能读取数据。可以解决脏读问题。但是了一个事务范围内两个相同的查询却返回了不同数据，这就是不可重复读。
3. 可重复读 REPEATABLE READ：就是在开始读取数据（事务开启）时，不再允许其它事务修改操作(update操作)。但可能会出现幻读，可允许其它事务insert操作。(事务开启－别的事务insert－事务提交(此时的数据跟事务开启时的数据不一致))。Mysql默认。
4. 可串行化　SERIALIZABLE：最高的事务隔离级别。在该级别下，事务串行化顺序执行，可以避免脏读、不可重复读与幻读。但是这种事务隔离级别效率低下，比较耗数据库性能，一般不使用。



使用raid技术：

- RAID0:将多个磁盘串联，并行写入。提高读写速度，但没有冗余，数据损坏概率提高(因为将一个文件写入了多个磁盘)
- RAID1:只提供了冗余。
- RAID5:分布式奇偶校验磁盘阵列。读性能可以，使用slave。
- RAID10: RAID0和RAID1的组合。

![election_51](assets/Selection_511.png)

存储引擎：

1. MyISAM:不支持事务，表级锁。只将索引缓存到内存。
2. InnoDB:事务级存储引擎，完美支持行级锁，事务ACID特性。同事缓存索引和数据。



数据库参数配置：



数据库表结构设计和SQL语句：



CentOS系统参数优化：

内核相关参数：/etc/sysctl.conf

- net.core.somaxconn=65535：每个端口的监听队列的最大长度
- net.core.netdev_max_backlog=65535：
- net.ipv4.tcp_max_syn_backlog=65535：
- net.ipv4.tcp_fin_timeout=10:tcp连接的超时时间
- net.ipv4.tcp_tw_reuse=1
- net.ipv4.tcp_tw_recycle=1　tcp连接的回收
- net.core.wmem_default=87380　tcp缓冲默认值
- net.core.rmem_max=16777216　tcp缓冲最大值
- net.ipv4.tcp_keepalive_time/intvl/probes 需要调小
- kernal.shmmax=4294967295应该足够大，能在一个共享内存段下容纳整个的Innodb缓冲池的大小。
- vm-swappiness=0

增加资源限制：/etc/security/limit.conf

* soft nofile 65535

  hard nofile 65535

磁盘调度策略：/sys/block/devname/queue/scheduler

noop anticipatory deadline查看调度策略(dfq)

noop电梯式调度策略：FIFO队列，饿死读，利于写。闪存设备、RAM、嵌入式

deadline截止时间调度策略，适合数据库。

anticipatory预料I/O调度策略。

文件系统：ext3 ext4 xfs

data=writeback noatime nodiratime



mysql体系架构：

![election_51](assets/Selection_512.png)

MyISAM存储引擎：MySql5.5之前默认。

MYD:数据文件　MYI:索引文件 .frm用于记录表结构。

特性：

- 表级锁：读取时加共享锁，可以在下面插入数据。
- 修复：check table name;repair table table name
- 不支持事务

